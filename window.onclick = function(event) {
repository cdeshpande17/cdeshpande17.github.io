window.onclick = function(event) {
  if (event.target.getAttribute("class") == "state") {
  var states = document.getElementsByClassName('state');
      for(var i = 0; i < states.length; i++) {
          var state = states[i];
    if(state.style.fillOpacity == 0.5){
      state.style.fillOpacity = 1;
    }
      }
      event.target.style.fillOpacity = 0.5;
  window.location.replace("state?state=" + event.target.getAttribute("stateName"));
  }
}

function tooltipHtml(n, d){	/* function to create html content string in tooltip div. */
  return "<h4>"+n+"</h4><table>"+
    "<tr><td>Low</td><td>"+(d.low)+"</td></tr>"+
    "<tr><td>Average</td><td>"+(d.avg)+"</td></tr>"+
    "<tr><td>High</td><td>"+(d.high)+"</td></tr>"+
    "</table>";
}

function calculateColor(data) {
		if(data < 0) {
			return d3.interpolate("#ffffff", "#da4900")(-data);
		} else {
			return d3.interpolate("#ffffff", "#0091da")(data);
		}
	}

  function readTextFile(file)  {
      var rawFile = new XMLHttpRequest();

      rawFile.onreadystatechange = function ()
      {
          if(rawFile.readyState === 4)
          {
              if(rawFile.status === 200 || rawFile.status == 0)
              {
                  var allText = rawFile.responseText;
                  //alert(allText);
  				var result = "{\"";
  				// By lines
  				var lines = allText.split('\n');
  				for(var line = 1; line < lines.length-2; line++){
  					var currLine = lines[line];
  					currLine = currLine.replace(",", "\": ");
  					result += currLine + ",\"";
  				}

  				var lastLine = lines[lines.length-2];
  				lastLine = lastLine.replace(",", "\": ");
  				result += lastLine + "}";
  				var states = JSON.parse(result);
          var sampleData ={};	/* Sample random data. */

          for (var state in states) {
              var data = states[state];
              sampleData[state] = {data:data, color:calculateColor(data)}

          }
          uStates.draw("#statesvg", sampleData, tooltipHtml);

          d3.select(self.frameElement).style("height", "600px");
              }
          }
      }
  	rawFile.open("GET", file, true);
    rawFile.send();
  }
readTextFile("/static/state-price-change.csv");
